<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>SuperLuis.app ‚Äì Rutina diaria (v4.20)</title>
<style>
  :root{
    --bg:#0f1116;--card:#171a20;--line:#232733;--fg:#e9edf2;--muted:#9aa2ad;
    --accent:#58d0ff;--ok:#1f9d55;--warn:#ffd54a;--danger:#ff4d4f;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,#0f1116 0%,rgba(15,17,22,.92) 100%);border-bottom:1px solid var(--line);padding:10px 12px}
  .bar{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .title{font-weight:800;letter-spacing:.3px}
  .hud{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#12151a;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:.95rem}
  main{padding:14px;max-width:880px;margin:0 auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#1b2230;border:1px solid var(--line);color:var(--fg);padding:9px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2d3546}
  button:disabled{opacity:.55;cursor:not-allowed}
  .ghost{background:transparent}
  .primary{background:var(--accent);border:none;color:#001018}
  .ok{background:var(--ok);border:none}
  .warn{background:#ffb300;color:#121212;border:none}
  .danger{background:var(--danger);border:none}
  .grid{display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .exercise-head{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .exercise-title{font-weight:750}
  .badge{font-size:.85rem;color:var(--muted)}
  .series{display:grid;gap:10px;margin-top:10px}
  .serie{border:1px dashed #2a2f3b;border-radius:12px;padding:10px;background:#141922}
  .serie.editable{background:#141922}
  .serie.live{background:#0f2d18;border-color:#1f7a4a}
  .serie.done{background:#0e2019;border-color:#1f7a4a}
  .serie-header{display:flex;align-items:center;justify-content:space-between}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:.9rem;color:var(--muted);background:#10141b}
  .num{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .num input{width:64px;background:#0f131a;color:var(--fg);border:0;padding:8px;text-align:center}
  .num button{border:0;background:#0f131a;width:36px}
  /* Banner descanso con alto contraste */
  .rest-card{position:sticky;top:56px;z-index:29;margin-top:8px;border:2px solid #111;border-radius:12px;padding:12px;background:var(--warn);color:#111;font-weight:700}
  .rest-card .muted{color:#222}
  .rest-card .actions button{background:#fff;border:2px solid #111;color:#111}
  .rest-card .actions button.warn{background:#ffe082}
  .hide{display:none}
  .muted{color:var(--muted)}
  .sep{height:1px;background:var(--line);margin:12px 0}
  footer{height:42px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">üèãÔ∏è‚Äç‚ôÇÔ∏è SuperLuis ‚Äì Rutina de hoy</div>
    <div class="hud">
      <div id="hudState" class="pill">Estado: <b>Listo</b></div>
      <div id="hudTimer" class="pill">Tiempo: <b>00:00</b></div>
      <div id="hudReps" class="pill">Reps: <b>0/0</b></div>
      <div class="pill"><label><input type="checkbox" id="autoNext" checked> Auto-siguiente</label></div>
    </div>
  </div>
  <div id="restBanner" class="rest-card hide">
    ‚è±Ô∏è Descanso: <b id="restLeft">0</b> s <span class="muted"> ¬∑ opciones abajo</span>
    <div style="margin-top:8px" class="actions rest-actions">
      <button id="btnRestPause">‚è∏Ô∏è Pausa</button>
      <button id="btnRestResume" disabled>‚ñ∂ Reanudar</button>
      <button id="btnRestSkip" class="warn">‚è© Saltar descanso</button>
    </div>
  </div>
</header>

<main>
  <div class="row actions">
    <button id="btnReset" class="ghost">‚Ü∫ Reset d√≠a</button>
    <button id="btnGuardar" class="ok">üíæ Guardar</button>
  </div>
  <div id="exercises" class="grid"></div>
</main>
<footer></footer>

<script>
/* ========== Utilidades ========== */
const $=s=>document.querySelector(s);
const fmt=n=>String(n).padStart(2,'0');
const now=()=>performance.now();
const speak=(txt)=>new Promise(res=>{
  const u=new SpeechSynthesisUtterance(txt);
  u.lang='es-ES';u.rate=1.02;u.pitch=1.0;u.onend=res; speechSynthesis.speak(u);
});
const beep=(hz=880,ms=120,gain=0.06)=>{
  const ac=new (window.AudioContext||window.webkitAudioContext)();
  const o=ac.createOscillator(), g=ac.createGain();
  o.type='square';o.frequency.value=hz;g.gain.value=gain;
  o.connect(g).connect(ac.destination);o.start();setTimeout(()=>{o.stop();ac.close()},ms);
};
const storeKey='sl_v420';
const save=(obj)=>localStorage.setItem(storeKey,JSON.stringify(obj));
const load=()=>{try{return JSON.parse(localStorage.getItem(storeKey))}catch{ return null }};

/* ========== Datos base (demo) ========== */
const planBase=[
  {id:'ex1',nombre:'Seated Chest Press',maquina:'L070',descanso:60,series:[
    {targetReps:10,reps:10,peso:57,done:false},
    {targetReps:10,reps:10,peso:57,done:false},
    {targetReps:10,reps:10,peso:57,done:false}
  ]},
  {id:'ex2',nombre:'Lat Pully Convergent',maquina:'Convergent 72.5',descanso:75,series:[
    {targetReps:5,reps:5,peso:72.5,done:false},
    {targetReps:5,reps:5,peso:72.5,done:false},
    {targetReps:5,reps:5,peso:72.5,done:false}
  ]},
  {id:'ex3',nombre:'Seated Row',maquina:'L090',descanso:60,series:[
    {targetReps:6,reps:6,peso:70,done:false},
    {targetReps:6,reps:6,peso:70,done:false}
  ]}
];

let state=load()||{
  autoNext:true,
  current:{phase:'idle',ex:0,serie:0,endTime:0,lastSecond:null}, // phase: idle|reps|rest
  plan:planBase
};
$('#autoNext').checked=state.autoNext;
$('#autoNext').onchange=e=>{state.autoNext=e.target.checked;save(state)};

/* ========== Render ========== */
function render(){
  const wrap=$('#exercises'); wrap.innerHTML='';
  state.plan.forEach((ex,ei)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="exercise-head">
        <div>
          <div class="exercise-title">${ex.nombre}</div>
          <div class="badge">M√°quina: ${ex.maquina} ¬∑ Descanso <b>${ex.descanso}</b> s</div>
        </div>
        <div class="actions">
          <button class="primary" data-act="start-ex" data-e="${ei}">‚ñ∂ Empezar ejercicio</button>
          <button class="ghost" data-act="add-serie" data-e="${ei}">Ôºã Serie</button>
          <button class="ghost" data-act="rest-edit" data-e="${ei}">‚öôÔ∏è Descanso</button>
        </div>
      </div>
      <div class="series" id="series-${ei}"></div>
    `;
    const sWrap=card.querySelector('.series');

    ex.series.forEach((s,si)=>{
      const live = state.current.phase!=='idle' && state.current.ex===ei && state.current.serie===si;
      const showOnlyLive = state.current.phase!=='idle' && state.current.ex===ei;
      const div=document.createElement('div');
      div.className='serie '+(s.done?'done':(live?'live':'editable'));
      if(showOnlyLive && !live) div.style.display='none';

      div.innerHTML=`
        <div class="serie-header">
          <div class="chips">
            <div class="chip">Serie <b>${si+1}</b></div>
            <div class="chip">Objetivo: ${s.targetReps} rep</div>
            <div class="chip">Estado: ${s.done?'‚úÖ Completada':(live?'‚è≥ En curso':'Pendiente')}</div>
          </div>
          <div class="actions">
            ${(!live && !s.done)?`<button data-act="start-serie" data-e="${ei}" data-s="${si}" class="ok">‚ñ∂ Iniciar serie</button>`:''}
            ${(!live && !s.done)?`<button data-act="del-serie" data-e="${ei}" data-s="${si}" class="danger">üóëÔ∏è</button>`:''}
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="muted" style="font-size:.85rem;margin-bottom:4px">Peso (kg)</div>
            <div class="num">
              <button data-act="peso-dec" data-e="${ei}" data-s="${si}">‚àí</button>
              <input data-field="peso" value="${Number(s.peso).toFixed(1)}" ${live?'disabled':''}>
              <button data-act="peso-inc" data-e="${ei}" data-s="${si}">+</button>
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:.85rem;margin-bottom:4px">Reps</div>
            <div class="num">
              <button data-act="reps-dec" data-e="${ei}" data-s="${si}">‚àí</button>
              <input data-field="reps" value="${s.reps}" ${live?'disabled':''}>
              <button data-act="reps-inc" data-e="${ei}" data-s="${si}">+</button>
            </div>
          </div>
          <div class="muted">Previsto: ${s.targetReps} rep</div>
        </div>

        ${live?`<div class="sep"></div>
          <div class="actions">
            <button data-act="mark-done" data-e="${ei}" data-s="${si}" class="ok">‚úî Terminar serie</button>
          </div>`:''}
      `;
      sWrap.appendChild(div);
    });

    wrap.appendChild(card);
  });

  // HUD estado
  $('#hudState').innerHTML=`Estado: <b>${
    state.current.phase==='idle'?'Listo':(state.current.phase==='reps'?'Serie en curso':'Descanso')}</b>`;
  save(state);
}
render();

/* ========== Motor de fases con reloj maestro ========== */
let rafId=null;
const clock={
  running:false,
  lastBeepSec:null,
  spokenSecSet:new Set(), // para 30/20/10 solo 1 vez
  start(phase,durSec){
    state.current.phase=phase;
    state.current.endTime = now() + durSec*1000;
    this.lastBeepSec=null; this.spokenSecSet.clear();
    this.running=true;
    loop();
  },
  stop(){ this.running=false; if(rafId) cancelAnimationFrame(rafId) }
};

function loop(){
  if(!clock.running){ return; }
  const msLeft = Math.max(0, state.current.endTime - now());
  const sLeft = Math.ceil(msLeft/1000);
  // HUD timer siempre desde el mismo reloj
  $('#hudTimer').innerHTML=`Tiempo: <b>${fmt(Math.floor(sLeft/60))}:${fmt(sLeft%60)}</b>`;

  if(state.current.phase==='rest'){
    $('#restLeft').textContent=sLeft;
    $('#restBanner').classList.remove('hide');

    // avisos 30/20/10 (solo una vez cada uno) + bip
    [30,20,10].forEach(v=>{
      if(sLeft===v && !clock.spokenSecSet.has(v)){
        clock.spokenSecSet.add(v);
        speak(`${v} segundos`); beep(700,100);
      }
    });
    // 3-2-1 bips distintos (no se pisan)
    if(clock.lastBeepSec!==sLeft){
      if(sLeft===3) beep(700,120);
      if(sLeft===2) beep(900,130);
      if(sLeft===1) beep(1200,220,0.08);
      clock.lastBeepSec=sLeft;
    }

    if(msLeft<=0){ // fin descanso -> siguiente serie
      $('#restBanner').classList.add('hide');
      clock.stop();
      avanzarTrasDescanso();
      return;
    }
  }

  rafId = requestAnimationFrame(loop);
}

/* ========== Serie / Descanso ========== */
let repTimer=null, repNum=0, repTarget=0;
function startExercise(ei){
  if(state.plan[ei].series.every(s=>s.done)) return;
  const si = state.plan[ei].series.findIndex(s=>!s.done);
  startSerie(ei, Math.max(0, si));
}
async function startSerie(ei,si){
  clearRepTimer(); clock.stop();
  const ex=state.plan[ei], s=ex.series[si];
  state.current.ex=ei; state.current.serie=si; state.current.phase='reps';
  repTarget = s.reps; repNum=0;
  $('#restBanner').classList.add('hide');
  $('#hudReps').innerHTML=`Reps: <b>0/${repTarget}</b>`;
  render();

  await speak(`Empezamos serie ${si+1}. ${repTarget} repeticiones.`);
  // temporizador de repeticiones a cadencia fija, y HUD lee del contador real
  repTimer = setInterval(async ()=>{
    repNum++;
    $('#hudReps').innerHTML=`Reps: <b>${repNum}/${repTarget}</b>`;
    await speak(`${repNum}. Arriba... Abajo...`);
    if(repNum>=repTarget){ clearRepTimer(); endSerie(ei,si); }
  }, 1200);
}
function clearRepTimer(){ if(repTimer){clearInterval(repTimer);repTimer=null} }

function endSerie(ei,si){
  state.plan[ei].series[si].done=true;
  render();
  startRest(ei, si);
}

async function startRest(ei,si){
  const ex=state.plan[ei];
  state.current.phase='rest';
  // Aviso de inicio y arranque de reloj maestro
  await speak(`Iniciamos descanso de ${ex.descanso} segundos.`);
  clock.start('rest', ex.descanso);
}

function avanzarTrasDescanso(){
  const ex = state.plan[state.current.ex];
  const next = ex.series.findIndex(s=>!s.done);
  if(next>=0){
    if(state.autoNext){ startSerie(state.current.ex, next); }
    else{ state.current.phase='idle'; render(); }
  }else{
    state.current.phase='idle'; render();
  }
}

/* ========== Controles UI ========== */
document.addEventListener('click', e=>{
  const el=e.target.closest('button'); if(!el) return;
  const act=el.dataset.act;
  if(act==='start-ex'){ startExercise(+el.dataset.e); return; }
  if(act==='start-serie'){ startSerie(+el.dataset.e,+el.dataset.s); return; }
  if(act==='del-serie'){
    const ei=+el.dataset.e, si=+el.dataset.s;
    if(state.plan[ei].series[si].done) return;
    state.plan[ei].series.splice(si,1); render(); return;
  }
  if(act==='peso-inc'||act==='peso-dec'||act==='reps-inc'||act==='reps-dec'){
    const ei=+el.dataset.e, si=+el.dataset.s, s=state.plan[ei].series[si];
    const live = state.current.phase==='reps' && state.current.ex===ei && state.current.serie===si;
    if(live) return;
    if(act==='peso-inc') s.peso=+(s.peso+0.5).toFixed(1);
    if(act==='peso-dec') s.peso=+(Math.max(0,s.peso-0.5)).toFixed(1);
    if(act==='reps-inc') s.reps=Math.min(120,s.reps+1);
    if(act==='reps-dec') s.reps=Math.max(1,s.reps-1);
    save(state); render(); return;
  }
  if(act==='mark-done'){
    const ei=+el.dataset.e, si=+el.dataset.s;
    if(state.current.phase!=='reps') return;
    clearRepTimer(); endSerie(ei,si); return;
  }
  if(act==='rest-edit'){
    const ei=+el.dataset.e; const v=prompt('Segundos de descanso:', state.plan[ei].descanso);
    if(!v) return; const n=Math.max(10, parseInt(v,10)||60);
    state.plan[ei].descanso=n; save(state); render(); return;
  }
});

document.addEventListener('input', e=>{
  const inp=e.target;
  if(!inp.matches('[data-field="peso"],[data-field="reps"]')) return;
  // localizar indices por DOM
  const card=inp.closest('.card');
  const ei=[...document.querySelectorAll('#exercises .card')].indexOf(card);
  const si=[...card.querySelector('.series').children].indexOf(inp.closest('.serie'));
  const s=state.plan[ei].series[si];
  if(inp.dataset.field==='peso'){
    let v=parseFloat((inp.value+'').replace(',','.')); if(isNaN(v)) v=s.peso;
    s.peso=+v.toFixed(1);
  }else{
    let v=parseInt(inp.value,10); if(isNaN(v)) v=s.reps;
    s.reps=Math.max(1,Math.min(120,v));
  }
  save(state);
});

/* Botones superiores */
$('#btnGuardar').onclick=()=>{ save(state); beep(1000,150,0.07); };
$('#btnReset').onclick=()=>{
  if(!confirm('¬øReiniciar el d√≠a?')) return;
  speechSynthesis.cancel(); clearRepTimer(); clock.stop();
  state={autoNext:$('#autoNext').checked,current:{phase:'idle',ex:0,serie:0,endTime:0,lastSecond:null},plan:JSON.parse(JSON.stringify(planBase))};
  $('#restBanner').classList.add('hide'); save(state); render();
};

/* Descanso: pausa / reanudar / saltar */
let paused=false;
$('#btnRestPause').onclick=()=>{
  if(state.current.phase!=='rest') return;
  if(paused) return;
  paused=true;
  // fijamos un nuevo endTime infinito‚Ä¶ pero guardamos ms restantes
  state._restRemain = Math.max(0, state.current.endTime - now());
  clock.stop();
};
$('#btnRestResume').onclick=()=>{
  if(state.current.phase!=='rest') return;
  if(!paused) return;
  paused=false;
  let remain = state._restRemain||0;
  if(remain<10000) remain=10000; // m√≠nimo 10 s al reanudar
  state.current.endTime = now() + remain;
  clock.running=true; loop();
};
$('#btnRestSkip').onclick=()=>{
  if(state.current.phase!=='rest') return;
  paused=false; clock.stop(); $('#restBanner').classList.add('hide'); avanzarTrasDescanso();
};

/* Al cargar */
window.addEventListener('load', render);
</script>
</body>
</html>