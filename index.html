<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SuperLuis.app – Rutina diaria</title>
<meta name="theme-color" content="#0f172a" />
<style>
:root{
  --bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--card:#111827;--card-strong:#0b1220;
  --primary:#2563eb;--ok:#10b981;--ok-strong:#065f46;--warn:#f59e0b;--danger:#ef4444;
  --border:#1f2937;--chip:#111827;
}
.light{
  --bg:#ffffff;--fg:#0f172a;--muted:#334155;--card:#f8fafc;--card-strong:#eef2f7;
  --primary:#2563eb;--ok:#059669;--ok-strong:#047857;--warn:#d97706;--danger:#dc2626;
  --border:#e5e7eb;--chip:#eef2f7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;
}
.container{max-width:920px;margin:0 auto;padding:16px 16px 120px}
header{
  position:sticky;top:0;z-index:50;background:linear-gradient(to bottom,var(--bg),color-mix(in srgb,var(--bg),transparent 10%));
  border-bottom:1px solid var(--border);backdrop-filter:blur(6px)
}
.header-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
.brand{font-weight:800;font-size:1.25rem;letter-spacing:.2px}
.btn{
  border:1px solid var(--border);background:var(--chip);color:var(--fg);padding:10px 14px;border-radius:14px;
  font-weight:600;cursor:pointer;transition:transform .05s ease,opacity .2s;
}
.btn:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:var(--primary);border-color:var(--primary);color:white}
.btn-ok{background:var(--ok);border-color:var(--ok);color:white}
.btn-warn{background:var(--warn);border-color:var(--warn);color:black}
.btn-ghost{background:transparent}
.row{display:flex;flex-wrap:wrap;gap:12px}
.chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--muted);font-size:.9rem}
.card{
  background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px 12px;margin:10px 0;
  box-shadow:0 1px 0 rgba(0,0,0,.1)
}
.card-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.h-title{font-weight:800}
.h-sub{color:var(--muted);font-size:.92rem}
.tools{display:flex;gap:8px;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:8px;background:#0b1324;border:1px solid var(--border);color:var(--muted);font-size:.8rem}
.exercise.done{background:color-mix(in srgb,var(--ok),transparent 86%);border-color:color-mix(in srgb,var(--ok),transparent 60%)}
.exercise.done .h-title{color:var(--ok)}
.series{margin-top:10px}
.series .item{
  border:1px dashed var(--border);border-radius:12px;padding:10px;margin:8px 0;background:var(--card-strong)
}
.series .item.editable{outline:2px dashed color-mix(in srgb,var(--primary),transparent 50%)}
.series .item.running{background:color-mix(in srgb,var(--ok),transparent 80%);border-color:var(--ok)}
.row-ctl{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.num{font-variant-numeric:tabular-nums}
.kg,.reps{display:flex;align-items:center;gap:6px}
.small{font-size:.9rem;color:var(--muted)}
hr.sep{border:none;border-top:1px dashed var(--border);margin:10px 0}
.sticky-rest{
  position:sticky;top:56px;z-index:40;background:color-mix(in srgb,var(--warn),transparent 75%);
  border:1px solid color-mix(in srgb,var(--warn),transparent 50%);color:black;border-radius:14px;margin:8px 0;padding:10px 12px;display:none
}
.sticky-rest.show{display:block}
footer{
  position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);
  padding:10px 16px;z-index:60
}
.grid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
label.switch{display:flex;align-items:center;gap:8px;cursor:pointer}
.switch input{appearance:none;width:40px;height:22px;border-radius:999px;background:#334155;position:relative;outline:none}
.switch input:checked{background:#16a34a}
.switch input::after{content:"";width:18px;height:18px;border-radius:999px;background:white;position:absolute;top:2px;left:2px;transition:left .18s}
.switch input:checked::after{left:20px}
kbd{background:#0b1324;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
.empty{opacity:.7;border:1px dashed var(--border);border-radius:12px;padding:14px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">SuperLuis.app</div>
    <div class="row">
      <button class="btn" id="btnTheme">Modo oscuro</button>
      <button class="btn" id="btnStartDay">Empezar ejercicio</button>
      <button class="btn" id="btnImport">Importar rutina</button>
      <button class="btn" id="btnSettings">Modo</button>
    </div>
  </div>
</header>

<div class="container">
  <section id="restBar" class="sticky-rest" aria-live="polite"></section>

  <section id="settings" class="card" style="display:none">
    <div class="card-header">
      <div>
        <div class="h-title">Ajustes</div>
        <div class="h-sub">Preferencias de ejecución</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <label class="switch"><input id="autoNext" type="checkbox" checked /> <span>Pasar a la siguiente serie automáticamente tras el descanso</span></label>
      <label class="switch"><input id="countEveryRep" type="checkbox" checked /> <span>Voz contando todas las repeticiones</span></label>
      <label class="switch"><input id="darkPref" type="checkbox" checked /> <span>Usar modo oscuro por defecto</span></label>
      <div class="chip">Tempo rep: <kbd id="tempoLbl">2.0s</kbd> <button class="btn" id="tempoMinus">–</button><button class="btn" id="tempoPlus">+</button></div>
      <div class="small">Consejo: si detienes el descanso y reanudas con menos de 10s, siempre verás una **cuenta atrás de 10s**.</div>
    </div>
  </section>

  <section id="routine"></section>

  <section id="empty" class="empty" style="display:none">
    No hay ejercicios hoy. Usa <b>Importar rutina</b> para pegar la tuya.
  </section>
</div>

<footer>
  <div class="grid">
    <div class="small">Consejo: <b>Empezar ejercicio</b> inicia la Serie 1 del siguiente ejercicio pendiente. El descanso aparece fijo bajo el menú.</div>
    <div class="row">
      <button class="btn btn-ghost" id="btnHome">Inicio</button>
      <button class="btn btn-primary" id="btnSave">Guardar</button>
    </div>
  </div>
</footer>

<script>
/* ========= Estado y datos de ejemplo ========= */
const state = {
  theme: 'dark',
  autoNext: true,
  countEveryRep: true,
  tempoMs: 2000, // duración total rep en ms (número + "arriba/abajo")
  restSecondsDefault: 60,
  speaking: false,
  queue: Promise.resolve(),
  current: { exIndex:null, seriesIndex:null, phase:'idle', restTimer:null, restLeft:0, paused:false },
  routine: []
};

// Rutina demo (puedes importar otra desde el botón)
state.routine = [
  {
    name:"Seated Chest Press", machine:"L070", planned:[
      {reps:6, weight:57}, {reps:6, weight:57}, {reps:6, weight:57}, {reps:6, weight:57}
    ], performed:[], rest:60, expanded:false, done:false
  },
  {
    name:"Chest Press Convergent", machine:"SEATED CHEST CONVERGENT", planned:[
      {reps:5, weight:55}, {reps:5, weight:55}, {reps:5, weight:55}, {reps:5, weight:55}
    ], performed:[], rest:60, expanded:false, done:false
  },
  {
    name:"Shoulder Press Convergent", machine:"SHOULDER PRESS CONVERGENT", planned:[
      {reps:5, weight:35}, {reps:5, weight:35}, {reps:5, weight:35}, {reps:5, weight:35}
    ], performed:[], rest:60, expanded:false, done:false
  },
  {
    name:"Tríceps – Extensión máquina", machine:"L150", planned:[
      {reps:6, weight:70}, {reps:6, weight:70}, {reps:6, weight:70}, {reps:6, weight:70}
    ], performed:[], rest:60, expanded:false, done:false
  }
];

/* ========= Utilidades UI ========= */
const el = sel => document.querySelector(sel);
const speak = (text, opts={})=>{
  const rate = opts.rate ?? 1;
  const pitch = opts.pitch ?? 1;
  const lang = 'es-ES';
  return new Promise(res=>{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang; u.rate = rate; u.pitch = pitch;
    u.onend = ()=>res();
    speechSynthesis.speak(u);
  });
};
// cola para evitar solapes
const say = (text, opts={})=>{
  state.queue = state.queue.then(()=>speak(text,opts));
  return state.queue;
};

// beep WebAudio
const beeper = new (window.AudioContext||window.webkitAudioContext)();
function beep(freq=880,duration=120,type='sine'){
  const o = beeper.createOscillator();
  const g = beeper.createGain();
  o.type=type;o.frequency.value=freq;
  o.connect(g); g.connect(beeper.destination);
  g.gain.setValueAtTime(0.0001, beeper.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, beeper.currentTime+0.01);
  o.start();
  setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, beeper.currentTime+0.03); o.stop(); }, duration);
}

/* ========= Render ========= */
function render(){
  document.body.classList.toggle('light', state.theme==='light');
  el('#btnTheme').textContent = state.theme==='light' ? 'Modo claro' : 'Modo oscuro';
  el('#autoNext').checked = state.autoNext;
  el('#countEveryRep').checked = state.countEveryRep;
  el('#tempoLbl').textContent = (state.tempoMs/1000).toFixed(1)+'s';

  const root = el('#routine');
  root.innerHTML = '';

  if(!state.routine.length){
    el('#empty').style.display='block'; return;
  } else el('#empty').style.display='none';

  state.routine.forEach((ex,i)=>{
    const card = document.createElement('div');
    card.className = 'card exercise'+(ex.done?' done':'');
    card.dataset.index=i;
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="h-title">${ex.name}</div>
          <div class="h-sub">Máquina: <b>${ex.machine}</b> · Descanso recomendado <b>${ex.rest||state.restSecondsDefault}s</b></div>
        </div>
        <div class="tools">
          <span class="badge">${ex.performed.length}/${ex.planned.length} series</span>
          <button class="btn btn-primary" data-action="start-ex">Empezar ejercicio</button>
          <button class="btn" data-action="toggle">${ex.expanded?'Ocultar':'Mostrar'}</button>
        </div>
      </div>
      <div class="series" ${ex.expanded?'':'style="display:none"'}></div>
    `;
    const list = card.querySelector('.series');

    // Solo mostrar serie pendiente cuando se expande (requisito)
    const sIndex = ex.performed.length; // próxima serie
    if(sIndex >= ex.planned.length){
      list.innerHTML = `<div class="small">Ejercicio completado ✔</div>`;
    }else{
      const base = ex.performed[sIndex-1] || ex.planned[sIndex];
      const item = document.createElement('div');
      item.className='item editable';
      item.dataset.sindex=sIndex;
      item.innerHTML = `
        <div class="row-ctl">
          <div><b>Serie ${sIndex+1}</b></div>
          <div class="kg">Peso:
            <button class="btn" data-action="wminus">-0.5</button>
            <span class="num" data-role="weight">${(+base.weight).toFixed(1)}</span> kg
            <button class="btn" data-action="wplus">+0.5</button>
          </div>
          <div class="reps">Reps:
            <button class="btn" data-action="rminus">-</button>
            <span class="num" data-role="reps">${base.reps}</span>
            <button class="btn" data-action="rplus">+</button>
          </div>
          <button class="btn btn-ok" data-action="start">Iniciar serie</button>
          <button class="btn" data-action="add">Añadir serie</button>
        </div>
        <div class="small">La siguiente serie copiará lo <b>realizado</b> aquí.</div>
      `;
      list.appendChild(item);
    }
    root.appendChild(card);
  });

  // Rest bar
  updateRestBar();
}

/* ========= Lógica de click ========= */
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button'); if(!btn) return;
  const card = ev.target.closest('.exercise');
  const action = btn.dataset.action;

  if(btn.id==='btnTheme'){ state.theme = (state.theme==='dark'?'light':'dark'); render(); return;}
  if(btn.id==='btnSettings'){ el('#settings').style.display = el('#settings').style.display==='none'?'block':'none'; return;}
  if(btn.id==='btnHome'){ window.scrollTo({top:0,behavior:'smooth'}); return;}
  if(btn.id==='btnSave'){localStorage.setItem('superluis-routine', JSON.stringify(state.routine)); beep(700,120); return;}
  if(btn.id==='btnStartDay'){ startNextExercise(); return;}
  if(btn.id==='btnImport'){ importRoutine(); return;}
  if(btn.id==='tempoMinus'){ state.tempoMs=Math.max(800,state.tempoMs-200); render(); return;}
  if(btn.id==='tempoPlus'){ state.tempoMs=Math.min(4000,state.tempoMs+200); render(); return;}

  if(!card) return;
  const exIndex = +card.dataset.index;
  const ex = state.routine[exIndex];

  if(action==='toggle'){ ex.expanded=!ex.expanded; render(); }
  if(action==='start-ex'){ ensureExpandedThenStart(exIndex); }
  if(!ex.expanded) return;

  const item = card.querySelector('.item'); if(!item) return;
  const sIndex = +item.dataset.sindex;
  const repsEl = item.querySelector('[data-role="reps"]');
  const wEl = item.querySelector('[data-role="weight"]');

  if(action==='wminus'){ wEl.textContent = (parseFloat(wEl.textContent)-0.5).toFixed(1); }
  if(action==='wplus'){  wEl.textContent = (parseFloat(wEl.textContent)+0.5).toFixed(1); }
  if(action==='rminus'){ repsEl.textContent = Math.max(1, (+repsEl.textContent-1)); }
  if(action==='rplus'){  repsEl.textContent = (+repsEl.textContent+1); }

  if(action==='add'){
    ex.planned.push( { reps: +repsEl.textContent, weight: +wEl.textContent } );
    render();
  }

  if(action==='start'){
    // bloquear edición visual
    item.classList.remove('editable'); item.classList.add('running');
    item.querySelectorAll('button').forEach(b=>{ if(b.dataset.action!=='start') b.disabled=true; });
    runSeries(exIndex, sIndex, +repsEl.textContent, +wEl.textContent);
  }
});

/* ========= Core: ejecutar serie + descanso ========= */
async function runSeries(exIndex, sIndex, reps, weight){
  state.current = { exIndex, seriesIndex:sIndex, phase:'series', restTimer:null, restLeft:0, paused:false };
  scrollRestIntoView();

  await say(`Empezamos serie ${sIndex+1}`);
  // Conteo descendente de repeticiones con ritmo
  for(let r=reps; r>=1; r--){
    if(!state.countEveryRep) break;
    await say(`${r}`);
    await wait(state.tempoMs*0.35);
    await say(`arriba`);
    await wait(state.tempoMs*0.3);
    await say(`abajo`);
    await wait(state.tempoMs*0.35);
  }

  // Guardar realizado
  const ex = state.routine[exIndex];
  ex.performed.push({ reps, weight });
  // Si ya no quedan series → marcar completado
  if(ex.performed.length >= ex.planned.length){
    ex.done = true;
  }
  render();

  // Descanso
  const restSec = ex.rest || state.restSecondsDefault;
  await startRest(restSec, exIndex);
  // Tras descanso
  const still = state.routine[exIndex];
  if(state.autoNext && still.performed.length < still.planned.length){
    ensureExpandedThenStart(exIndex); // siguiente serie
  }else{
    // solo esperar a que el usuario inicie
  }
}

function ensureExpandedThenStart(exIndex){
  const ex = state.routine[exIndex];
  ex.expanded = true; render();
  const card = document.querySelector(`.exercise[data-index="${exIndex}"]`);
  const btn = card?.querySelector('.item .btn.btn-ok[data-action="start"]');
  if(btn){ btn.click(); card.scrollIntoView({behavior:'smooth',block:'start'}); }
}

function startNextExercise(){
  const idx = state.routine.findIndex(ex=>ex.performed.length < ex.planned.length);
  if(idx===-1){ beep(300,200,'square'); say('Rutina completada. ¡Muy bien!'); return;}
  ensureExpandedThenStart(idx);
}

function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ========= Descanso (barra sticky) ========= */
function updateRestBar(){
  const bar = el('#restBar');
  if(state.current.phase!=='rest'){ bar.classList.remove('show'); bar.innerHTML=''; return; }
  const left = state.current.restLeft|0;
  bar.classList.add('show');
  bar.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <div><b>Descanso</b> · <span class="num">${left}s</span></div>
      <div class="row">
        <button class="btn" id="btnPause">${state.current.paused?'Continuar':'Pausa'}</button>
        <button class="btn btn-warn" id="btnSkip">Saltar descanso</button>
      </div>
    </div>
  `;
}
async function startRest(totalSec, exIndex){
  state.current.phase='rest'; state.current.restLeft=totalSec; state.current.paused=false;
  updateRestBar();
  await say(`Iniciamos descanso de ${totalSec} segundos`);

  return new Promise((resolve)=>{
    let lastTick = Date.now();
    function tick(){
      if(state.current.phase!=='rest'){ resolve(); return; }
      const now = Date.now();
      if(!state.current.paused){
        const delta = (now-lastTick)/1000;
        state.current.restLeft = Math.max(0, state.current.restLeft - delta);
        const left = state.current.restLeft|0;

        // Avisos
        if(left>0 && left%10===0){ say(`${left} segundos`); }
        if(left===3){ beep(880,140); }
        if(left===2){ beep(980,140); }
        if(left===1){ beep(1160,160); }

        updateRestBar();
        if(left<=0){
          state.current.phase='idle'; updateRestBar();
          say('Volvemos al trabajo'); resolve(); return;
        }
      }
      lastTick = now;
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // listeners de barra
    document.addEventListener('click', function handler(ev){
      const b = ev.target.closest('button'); if(!b) return;
      if(b.id==='btnPause'){
        if(!state.current.paused){
          state.current.paused = true;
        }else{
          // reanudar con al menos 10s
          state.current.paused = false;
          if(state.current.restLeft<10) state.current.restLeft=10;
        }
        updateRestBar();
      }
      if(b.id==='btnSkip'){
        // pasar a siguiente serie del mismo ejercicio
        state.current.phase='idle'; updateRestBar();
        document.removeEventListener('click', handler);
        resolve();
      }
    }, {once:false});
  });
}

/* ========= Importar/exportar ========= */
function importRoutine(){
  const text = prompt('Pega aquí tu rutina en JSON o escribe: nombre|máquina|reps,kg;reps,kg ...\n\nEjemplo:\nSeated Chest Press|L070|6,57;6,57;6,57;6,57');
  if(!text) return;
  let r=[];
  try{
    if(text.trim().startsWith('[')){ r = JSON.parse(text); }
    else{
      // formato simple por líneas
      const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const ln of lines){
        const [name,machine,series] = ln.split('|');
        const planned = series.split(';').map(x=>{
          const [reps,kg] = x.split(',').map(v=>v.trim());
          return { reps:+reps, weight:+kg };
        });
        r.push({name:name||'Ejercicio',machine:machine||'-',planned,performed:[],rest:60,expanded:false,done:false});
      }
    }
    state.routine = r;
    render();
  }catch(e){
    alert('Formato no válido');
  }
}

/* ========= Preferencias ========= */
el('#autoNext').addEventListener('change', e=> state.autoNext=e.target.checked );
el('#countEveryRep').addEventListener('change', e=> state.countEveryRep=e.target.checked );
el('#darkPref').addEventListener('change', e=> { state.theme = e.target.checked?'dark':'light'; render(); });

/* ========= Init ========= */
(function init(){
  try{
    const saved = localStorage.getItem('superluis-routine');
    if(saved){ state.routine = JSON.parse(saved); }
  }catch{}
  render();
})();
</script>
</body>
</html>