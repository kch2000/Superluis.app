<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SuperLuis.app</title>
<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:#e2e8f0}
header{background:#111827;padding:10px;position:sticky;top:0}
button{margin:3px;padding:6px 10px;border:none;border-radius:6px}
.btn-ok{background:#10b981;color:white}
.btn-warn{background:#fbbf24;color:black}
.exercise{border:1px solid #1f2937;margin:10px;padding:10px;border-radius:8px;background:#1e293b}
.exercise.done{background:#065f46}
.series .item{margin:8px 0;padding:8px;border:1px dashed #475569;border-radius:6px}
.item.running{background:#064e3b}
#restBar{position:sticky;top:50px;background:#fbbf24;color:black;padding:6px;display:none}
</style>
</head>
<body>
<header>
  <b>SuperLuis.app</b>
  <button id="btnStartDay">Empezar ejercicio</button>
</header>

<div id="restBar"></div>
<div id="routine"></div>

<script>
const state={
  routine:[
    {name:"Seated Chest Press",machine:"L070",planned:[{reps:10,weight:57},{reps:10,weight:57},{reps:10,weight:57}],performed:[],rest:20,expanded:true,done:false}
  ],
  current:{phase:'idle',exIndex:null,sIndex:null,restTimer:null,restLeft:0,paused:false},
  queue:Promise.resolve()
};

// ---- voz y beeps ----
function say(t){ state.queue=state.queue.then(()=>new Promise(r=>{let u=new SpeechSynthesisUtterance(t);u.lang='es-ES';u.onend=r;window.speechSynthesis.speak(u)}));return state.queue;}
const ctx=new (window.AudioContext||window.webkitAudioContext)();
function beep(f=880){let o=ctx.createOscillator();o.frequency.value=f;o.connect(ctx.destination);o.start();setTimeout(()=>o.stop(),200);}

// ---- render ----
function render(){
  const root=document.getElementById('routine');root.innerHTML='';
  state.routine.forEach((ex,i)=>{
    let card=document.createElement('div');card.className='exercise'+(ex.done?' done':'');card.dataset.i=i;
    card.innerHTML=`<h3>${ex.name} (${ex.machine})</h3>
      <div class="series"></div>`;
    let s=card.querySelector('.series');
    if(ex.performed.length>=ex.planned.length){s.innerHTML='<i>Completado ✔</i>';}
    else{
      let idx=ex.performed.length;
      let base=ex.planned[idx];
      let it=document.createElement('div');
      it.className='item';it.dataset.s=idx;
      it.innerHTML=`Serie ${idx+1}: 
        <span data-r>${base.reps}</span> reps · 
        <span data-w>${base.weight}</span>kg
        <button data-a="r-">-</button><button data-a="r+">+</button>
        <button data-a="w-">-0.5</button><button data-a="w+">+0.5</button>
        <button class="btn-ok" data-a="start">Iniciar</button>`;
      s.appendChild(it);
    }
    root.appendChild(card);
  });
  updateRestBar();
}
function updateRestBar(){
  let bar=document.getElementById('restBar');
  if(state.current.phase!=='rest'){bar.style.display='none';return;}
  bar.style.display='block';
  bar.textContent=`Descanso: ${state.current.restLeft|0}s  `;
  let btn=document.createElement('button');btn.textContent=state.current.paused?'Continuar':'Pausa';btn.onclick=()=>{
    if(state.current.paused){state.current.paused=false;if(state.current.restLeft<10)state.current.restLeft=10;}else state.current.paused=true;};
  bar.appendChild(btn);
  let b2=document.createElement('button');b2.textContent='Saltar';b2.className='btn-warn';b2.onclick=()=>{state.current.phase='idle';};
  bar.appendChild(b2);
}

// ---- clicks ----
document.addEventListener('click',ev=>{
  let b=ev.target.closest('button');if(!b)return;
  let a=b.dataset.a;let card=ev.target.closest('.exercise');if(!card)return;
  let ex=state.routine[card.dataset.i];let it=card.querySelector('.item');
  if(!it)return;let repsEl=it.querySelector('[data-r]');let wEl=it.querySelector('[data-w]');
  if(a==='r-') repsEl.textContent=Math.max(1,+repsEl.textContent-1);
  if(a==='r+') repsEl.textContent=+repsEl.textContent+1;
  if(a==='w-') wEl.textContent=(+wEl.textContent-0.5).toFixed(1);
  if(a==='w+') wEl.textContent=(+wEl.textContent+0.5).toFixed(1);
  if(a==='start'){ it.classList.add('running'); runSeries(+card.dataset.i,+it.dataset.s,+repsEl.textContent,+wEl.textContent);}
});
document.getElementById('btnStartDay').onclick=()=>{let idx=state.routine.findIndex(ex=>ex.performed.length<ex.planned.length);if(idx>=0){let ex=state.routine[idx];let btn=document.querySelector(`.exercise[data-i="${idx}"] [data-a="start"]`);btn?.click();}};

// ---- ejecutar serie ----
async function runSeries(exI,sI,reps,w){
  state.current={phase:'series',exIndex:exI,sIndex:sI};
  await say(`Empezamos serie ${sI+1}`);
  for(let r=reps;r>=1;r--){
    await say(`${r}`);await say("arriba");await say("abajo");
  }
  state.routine[exI].performed.push({reps,weight:w});
  if(state.routine[exI].performed.length>=state.routine[exI].planned.length){state.routine[exI].done=true;}
  render();
  await startRest(state.routine[exI].rest||20);
  if(state.routine[exI].performed.length<state.routine[exI].planned.length){let btn=document.querySelector(`.exercise[data-i="${exI}"] [data-a="start"]`);btn?.click();}
}

function startRest(sec){return new Promise(res=>{
  state.current={phase:'rest',restLeft:sec,paused:false};
  say(`Iniciamos descanso de ${sec} segundos`);
  function tick(){
    if(state.current.phase!=='rest'){res();render();return;}
    if(!state.current.paused){
      state.current.restLeft-=1;updateRestBar();
      if(state.current.restLeft%10===0&&state.current.restLeft>0) say(`${state.current.restLeft} segundos`);
      if([3,2,1].includes(state.current.restLeft)) beep(500+state.current.restLeft*200);
      if(state.current.restLeft<=0){state.current.phase='idle';say("Vamos a la siguiente serie");res();}
    }
    setTimeout(tick,1000);
  }
  tick();
});}

render();
</script>
</body>
</html>