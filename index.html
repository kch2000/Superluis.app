<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>SuperLuis.app ‚Äì Rutina</title>
<style>
  :root{
    --bg:#0e0f12;--card:#171a20;--muted:#8a9099;--fg:#e9edf2;--accent:#5dd0ff;
    --ok:#1f9d55;--warn:#ffcc00;--danger:#ff4d4f;--line:#232733;--pill:#12151b;--input:#0f1218;
  }
  body.light{
    --bg:#f5f7fb;--card:#ffffff;--muted:#5b6572;--fg:#14171c;--accent:#006dff;
    --ok:#148a4a;--warn:#ffbf00;--danger:#e23b3f;--line:#dfe5ee;--pill:#f0f4fa;--input:#f6f9fe;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,var(--bg) 0%,rgba(0,0,0,.02) 100%);
    border-bottom:1px solid var(--line);padding:10px 12px}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .title{font-weight:700;letter-spacing:.3px}
  .hud{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:.95rem}
  main{padding:14px;max-width:900px;margin:0 auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#1c222d;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  body.light button{background:#eaf1fb;color:#0b203b}
  button:hover{border-color:#2c3240}
  body.light button:hover{border-color:#c6d9f5}
  button:disabled{opacity:.55;cursor:not-allowed}
  .ghost{background:transparent}
  .primary{background:var(--accent);color:#001018;border:none}
  .danger{background:var(--danger);border:none}
  .warn{background:var(--warn);color:#181a1f;border:none}
  .ok{background:var(--ok);border:none}
  .grid{display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .exercise-head{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .exercise-title{font-weight:700}
  .badge{font-size:.78rem;color:var(--muted)}
  .series{display:grid;gap:10px;margin-top:10px}
  .serie{border:1px dashed #2a2f3b;border-radius:12px;padding:10px}
  body.light .serie{border-color:#d9e3f2}
  .serie.editable{background:#141923}
  .serie.live{background:#06240f;border-color:#1f7a4a}
  .serie.done{background:#0d211a;border-color:#1f7a4a}
  body.light .serie.editable{background:#f4f7fc}
  body.light .serie.live{background:#e7f7ec;border-color:#aee0c0}
  body.light .serie.done{background:#eaf6ef;border-color:#aee0c0}
  .serie-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:.9rem;color:var(--muted)}
  .num{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .num input{width:64px;background:var(--input);color:var(--fg);border:0;padding:8px;text-align:center}
  body.light .num input{color:#0b203b}
  .num button{border:0;background:var(--input);width:36px}
  .yellow{background:var(--warn);color:#181a1f}
  .rest-card{position:sticky;top:56px;z-index:19;margin-top:8px;border:0;border-radius:12px;padding:10px}
  .rest-card.hide{display:none}
  .muted{color:var(--muted)}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .banner-controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  footer{height:42px}
  .switch{cursor:pointer;display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">üèãÔ∏è‚Äç‚ôÇÔ∏è SuperLuis ‚Äì Rutina de hoy</div>
    <div class="hud">
      <div id="hudState" class="pill">Estado: <b>Listo</b></div>
      <div id="hudTimer" class="pill">Tiempo: <b>00:00</b></div>
      <div id="hudReps" class="pill">Reps: <b>0/0</b></div>
      <div class="pill"><label class="switch"><input type="checkbox" id="autoNext" checked> Auto-siguiente</label></div>
      <div class="pill"><label class="switch"><input type="checkbox" id="lightMode"> Modo claro</label></div>
    </div>
  </div>
  <div id="restBanner" class="rest-card yellow hide">
    <div><b>‚è±Ô∏è Descanso:</b> <span id="restLeft">0</span> s</div>
    <div class="banner-controls">
      <!-- Ajuste reps realizadas (serie previa) -->
      <div class="pill">
        √öltima serie ¬∑ hechas:
        <button id="lastRepsDec">‚àí</button>
        <span id="lastRepsVal">0</span>
        <button id="lastRepsInc">+</button>
      </div>
      <!-- Configurar pr√≥xima serie -->
      <div class="pill">
        Pr√≥xima serie ¬∑ Peso:
        <button id="nextPesoDec">‚àí</button>
        <span id="nextPesoVal">0</span> kg
        <button id="nextPesoInc">+</button>
      </div>
      <div class="pill">
        Pr√≥xima serie ¬∑ Reps:
        <button id="nextRepsDec">‚àí</button>
        <span id="nextRepsVal">0</span>
        <button id="nextRepsInc">+</button>
      </div>
    </div>
    <div class="banner-controls">
      <button id="btnRestPause" class="ghost">‚è∏Ô∏è Pausa</button>
      <button id="btnRestResume" class="ghost" disabled>‚ñ∂ Reanudar</button>
      <button id="btnRestSkip" class="warn">‚è© Saltar descanso</button>
    </div>
  </div>
</header>

<main>
  <div class="row actions">
    <button id="btnReset" class="ghost">‚Ü∫ Reset d√≠a</button>
    <button id="btnGuardar" class="ok">üíæ Guardar</button>
  </div>
  <div id="exercises" class="grid"></div>
</main>
<footer></footer>

<script>
/* ====== Helpers ====== */
const $=s=>document.querySelector(s);
const fmt=n=>String(n).padStart(2,'0');
const acFactory=()=> new (window.AudioContext||window.webkitAudioContext)();
const beep=(hz=880,ms=120,gain=0.06)=>{
  const ac=acFactory(), o=ac.createOscillator(), g=ac.createGain();
  o.type='square'; o.frequency.value=hz; g.gain.value=gain;
  o.connect(g).connect(ac.destination); o.start(); setTimeout(()=>{o.stop();ac.close()},ms);
};
const speakQ=(()=>{
  let speaking=false,q=[];
  const next=()=>{ if(speaking||!q.length) return;
    speaking=true; const {text,onend}=q.shift();
    const u=new SpeechSynthesisUtterance(text); u.lang='es-ES'; u.rate=1.02; u.pitch=1.0;
    u.onend=()=>{ speaking=false; onend&&onend(); next(); };
    speechSynthesis.speak(u);
  };
  return (text,onend)=>{ q.push({text,onend}); next(); };
})();
const storeKey='sl_routine_v2';
const save=st=>localStorage.setItem(storeKey,JSON.stringify(st));
const load=()=>{try{return JSON.parse(localStorage.getItem(storeKey))}catch(e){return null}};

/* ====== Datos demo ====== */
const defaultPlan=[
 {id:'ex1',nombre:'Seated Chest Press',maquina:'L070',descanso:60, series:[
   {targetReps:10,reps:10,peso:57,done:false,performedReps:0},
   {targetReps:10,reps:10,peso:57,done:false,performedReps:0},
   {targetReps:10,reps:10,peso:57,done:false,performedReps:0}
 ]},
 {id:'ex2',nombre:'Lat Pully Convergent',maquina:'Convergent 72.5',descanso:75, series:[
   {targetReps:5,reps:5,peso:72.5,done:false,performedReps:0},
   {targetReps:5,reps:5,peso:72.5,done:false,performedReps:0},
   {targetReps:5,reps:5,peso:72.5,done:false,performedReps:0}
 ]},
 {id:'ex3',nombre:'Seated Row',maquina:'L090',descanso:60, series:[
   {targetReps:6,reps:6,peso:70,done:false,performedReps:0},
   {targetReps:6,reps:6,peso:70,done:false,performedReps:0}
 ]}
];

let state=load()||{
  autoNext:true,
  theme:'dark', // 'dark' | 'light'
  current:{ex:0,serie:0,mode:'idle'}, // idle | reps | rest
  plan:defaultPlan
};
document.body.classList.toggle('light', state.theme==='light');
$('#lightMode').checked = state.theme==='light';
$('#lightMode').addEventListener('change', e=>{
  state.theme = e.target.checked?'light':'dark';
  document.body.classList.toggle('light', e.target.checked);
  save(state);
});

$('#autoNext').checked=!!state.autoNext;
$('#autoNext').addEventListener('change',e=>{state.autoNext=e.target.checked;save(state)});

/* ====== Render ====== */
function render(){
  const wrap=$('#exercises'); wrap.innerHTML='';
  state.plan.forEach((ex,ei)=>{
    const card=document.createElement('div'); card.className='card';
    const head=document.createElement('div'); head.className='exercise-head';
    head.innerHTML=`
      <div>
        <div class="exercise-title">${ex.nombre}</div>
        <div class="badge">M√°quina: ${ex.maquina} ¬∑ Descanso <b>${ex.descanso}</b> s</div>
      </div>
      <div class="actions">
        <button class="primary" data-action="start-ex" data-e="${ei}">‚ñ∂ Empezar ejercicio</button>
        <button class="ghost" data-action="add-serie" data-e="${ei}">Ôºã Serie</button>
        <button class="ghost" data-action="rest-edit" data-e="${ei}">‚öôÔ∏è Descanso</button>
      </div>
    `;
    card.appendChild(head);

    const list=document.createElement('div'); list.className='series';
    ex.series.forEach((s,si)=>{
      const isLive=(state.current.mode==='reps' && state.current.ex===ei && state.current.serie===si);
      // ocultar series NO relevantes: durante reps muestra solo la activa; durante rest no mostramos ninguna tarjeta (se gestiona en banner)
      const hideDuringReps = (state.current.mode==='reps' && !isLive && state.current.ex===ei);
      const div=document.createElement('div');
      div.className='serie '+(isLive?'live':(s.done?'done':'editable'));
      if(hideDuringReps) div.style.display='none';

      div.innerHTML=`
        <div class="serie-header">
          <div class="chips">
            <div class="chip">Serie <b>${si+1}</b></div>
            <div class="chip">Objetivo: ${s.targetReps} rep</div>
            <div class="chip">Estado: ${s.done?'‚úÖ Completada': (isLive?'‚è≥ En curso':'Pendiente')}</div>
          </div>
          <div class="actions">
            ${!isLive && !s.done ? `<button data-action="start-serie" data-e="${ei}" data-s="${si}" class="ok">‚ñ∂ Iniciar serie</button>`:''}
            ${!isLive && !s.done ? `<button data-action="del-serie" data-e="${ei}" data-s="${si}" class="danger">üóëÔ∏è</button>`:''}
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="muted" style="font-size:.85rem;margin-bottom:4px">Peso (kg)</div>
            <div class="num">
              <button data-action="peso-dec" data-e="${ei}" data-s="${si}" ${isLive?'disabled':''}>‚àí</button>
              <input data-field="peso" value="${Number(s.peso).toFixed(1)}" ${isLive?'disabled':''}>
              <button data-action="peso-inc" data-e="${ei}" data-s="${si}" ${isLive?'disabled':''}>+</button>
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:.85rem;margin-bottom:4px">Reps (previstas)</div>
            <div class="num">
              <button data-action="reps-dec" data-e="${ei}" data-s="${si}" ${isLive?'disabled':''}>‚àí</button>
              <input data-field="reps" value="${s.reps}" ${isLive?'disabled':''}>
              <button data-action="reps-inc" data-e="${ei}" data-s="${si}" ${isLive?'disabled':''}>+</button>
            </div>
          </div>
          ${s.done?`<div class="muted">Hechas: <b>${s.performedReps||s.reps}</b></div>`:''}
        </div>

        ${isLive?`<div class="sep"></div>
          <div class="actions">
            <button data-action="mark-done" data-e="${ei}" data-s="${si}" class="ok">‚úî Terminar serie</button>
          </div>`:''}
      `;
      list.appendChild(div);
    });
    card.appendChild(list);
    wrap.appendChild(card);
  });

  $('#hudState').innerHTML=`Estado: <b>${
    state.current.mode==='idle'?'Listo':(state.current.mode==='reps'?'Serie en curso':'Descanso')
  }</b>`;
  save(state);
}
render();

/* ====== Timers y l√≥gica ====== */
let repTimer=null, restTimer=null, repCount=0, repTarget=0, restLeft=0;
let paused=false;
function clearTimers(){ if(repTimer){clearInterval(repTimer);repTimer=null} if(restTimer){clearInterval(restTimer);restTimer=null} }

function startExercise(ei){
  const next = state.plan[ei].series.findIndex(s=>!s.done);
  if(next>=0) startSerie(ei,next);
}

function startSerie(ei,si){
  clearTimers();
  const ex=state.plan[ei], s=ex.series[si];
  state.current={ex:ei,serie:si,mode:'reps'};
  repTarget = s.reps; repCount=0;
  $('#restBanner').classList.add('hide');
  $('#hudReps').innerHTML=`Reps: <b>0/${repTarget}</b>`;
  render();

  speakQ(`Empezamos serie ${si+1}. ${repTarget} repeticiones.`, ()=>{
    repTimer=setInterval(()=>{
      if(repCount>=repTarget){ clearInterval(repTimer); repTimer=null; endSerie(ei,si); return; }
      repCount++;
      $('#hudReps').innerHTML=`Reps: <b>${repCount}/${repTarget}</b>`;
      speakQ(`${repCount}. Arriba... Abajo...`);
    },1200);
  });
}

function endSerie(ei,si){
  const s=state.plan[ei].series[si];
  s.done=true; s.performedReps=repCount;
  render();
  startRest(ei,si);
}

function setupRestBanner(ei, si){
  const ex=state.plan[ei];
  const last = ex.series[si];
  // Pr√≥xima serie (si existe)
  const nextIdx = ex.series.findIndex((t,i)=>!t.done && i>si);
  const nextSerie = nextIdx>=0 ? ex.series[nextIdx] : null;

  $('#lastRepsVal').textContent = last.performedReps||last.reps||0;

  const syncLast = (delta)=>{
    last.performedReps = Math.max(0,(last.performedReps||last.reps||0)+delta);
    $('#lastRepsVal').textContent = last.performedReps;
    save(state); render();
  };
  $('#lastRepsInc').onclick=()=>syncLast(+1);
  $('#lastRepsDec').onclick=()=>syncLast(-1);

  if(nextSerie){
    $('#nextPesoVal').textContent = Number(nextSerie.peso).toFixed(1);
    $('#nextRepsVal').textContent = nextSerie.reps;

    const updNext=(field,delta,step=1)=>{
      if(field==='peso'){
        nextSerie.peso = +(Math.max(0, nextSerie.peso + delta*0.5)).toFixed(1);
        $('#nextPesoVal').textContent = nextSerie.peso.toFixed(1);
      }else{
        nextSerie.reps = Math.max(1, nextSerie.reps + delta*step);
        $('#nextRepsVal').textContent = nextSerie.reps;
      }
      save(state); render();
    };
    $('#nextPesoInc').onclick=()=>updNext('peso',+1);
    $('#nextPesoDec').onclick=()=>updNext('peso',-1);
    $('#nextRepsInc').onclick=()=>updNext('reps',+1);
    $('#nextRepsDec').onclick=()=>updNext('reps',-1);
  }else{
    $('#nextPesoVal').textContent = '‚Äî';
    $('#nextRepsVal').textContent = '‚Äî';
    ['nextPesoInc','nextPesoDec','nextRepsInc','nextRepsDec'].forEach(id=>{$('#'+id).onclick=null});
  }
}

function startRest(ei,si){
  const ex=state.plan[ei];
  restLeft = ex.descanso;
  state.current.mode='rest'; paused=false;
  $('#restBanner').classList.remove('hide');
  $('#restLeft').textContent = restLeft;
  $('#hudTimer').innerHTML=`Tiempo: <b>${fmt(Math.floor(restLeft/60))}:${fmt(restLeft%60)}</b>`;
  setupRestBanner(ei, si);
  speakQ(`Iniciamos descanso de ${restLeft} segundos.`);

  clearInterval(restTimer);
  restTimer=setInterval(()=>{
    if(paused) return;
    restLeft--;
    if([30,20,10].includes(restLeft)){ speakQ(`${restLeft} segundos`); beep(700,110); }
    if(restLeft===3){ beep(700,120) }
    if(restLeft===2){ beep(900,130) }
    if(restLeft===1){ beep(1200,220,0.08) }

    $('#restLeft').textContent=restLeft;
    $('#hudTimer').innerHTML=`Tiempo: <b>${fmt(Math.floor(restLeft/60))}:${fmt(restLeft%60)}</b>`;

    if(restLeft<=0){
      clearInterval(restTimer); restTimer=null;
      $('#restBanner').classList.add('hide');
      // siguiente serie mismo ejercicio
      const next = ex.series.findIndex((t,i)=>!t.done && i>si);
      if(next>=0){
        if(state.autoNext){ startSerie(ei,next); }
        else{ state.current.mode='idle'; render(); }
      }else{
        state.current.mode='idle'; render();
      }
    }
  },1000);

  // Controles descanso
  $('#btnRestPause').disabled=false;
  $('#btnRestResume').disabled=true;
  $('#btnRestPause').onclick=()=>{ if(state.current.mode!=='rest')return; paused=true; $('#btnRestPause').disabled=true; $('#btnRestResume').disabled=false; };
  $('#btnRestResume').onclick=()=>{ if(state.current.mode!=='rest')return; if(restLeft<10) restLeft=10; paused=false; $('#restLeft').textContent=restLeft; $('#btnRestPause').disabled=false; $('#btnRestResume').disabled=true; };
  $('#btnRestSkip').onclick=()=>{
    if(state.current.mode!=='rest')return;
    clearInterval(restTimer); restTimer=null; $('#restBanner').classList.add('hide');
    const next = ex.series.findIndex((t,i)=>!t.done && i>si);
    if(next>=0) startSerie(ei,next); else { state.current.mode='idle'; render(); }
  };
}

/* ====== Eventos UI ====== */
document.addEventListener('click', e=>{
  const el=e.target.closest('button'); if(!el) return;
  const a=el.dataset.action;

  if(a==='start-ex'){ startExercise(+el.dataset.e); return; }
  if(a==='start-serie'){ startSerie(+el.dataset.e,+el.dataset.s); return; }
  if(a==='del-serie'){
    const ei=+el.dataset.e, si=+el.dataset.s;
    if(state.plan[ei].series[si].done) return;
    state.plan[ei].series.splice(si,1); save(state); render(); return;
  }
  if(a==='add-serie'){
    const ei=+el.dataset.e; const ex=state.plan[ei];
    const tpl = ex.series.length? ex.series[ex.series.length-1] : {targetReps:10,reps:10,peso:0,done:false,performedReps:0};
    ex.series.push({targetReps:tpl.targetReps,reps:tpl.reps,peso:tpl.peso,done:false,performedReps:0});
    save(state); render(); return;
  }
  if(a==='peso-inc'||a==='peso-dec'||a==='reps-inc'||a==='reps-dec'){
    const ei=+el.dataset.e, si=+el.dataset.s; const s=state.plan[ei].series[si];
    if(state.current.mode==='reps' && state.current.ex===ei && state.current.serie===si) return;
    if(a==='peso-inc') s.peso=+(s.peso+0.5).toFixed(1);
    if(a==='peso-dec') s.peso=+(Math.max(0,s.peso-0.5)).toFixed(1);
    if(a==='reps-inc') s.reps=Math.min(200,s.reps+1);
    if(a==='reps-dec') s.reps=Math.max(1,s.reps-1);
    save(state); render(); return;
  }
  if(a==='rest-edit'){
    const ei=+el.dataset.e; const n=prompt('Segundos de descanso para este ejercicio:', state.plan[ei].descanso);
    if(!n) return; state.plan[ei].descanso=Math.max(10,parseInt(n,10)||60); save(state); render(); return;
  }
  if(a==='mark-done'){
    const ei=+el.dataset.e, si=+el.dataset.s;
    if(state.current.mode!=='reps') return;
    clearTimers(); endSerie(ei,si); return;
  }
});

document.addEventListener('input', e=>{
  const inp=e.target;
  if(inp.matches('[data-field="peso"],[data-field="reps"]')){
    const card=inp.closest('.card'); const ei=[...$('#exercises').children].indexOf(card);
    const si=[...card.querySelector('.series').children].indexOf(inp.closest('.serie'));
    const s=state.plan[ei].series[si];
    if(inp.dataset.field==='peso'){
      let v=parseFloat((inp.value||'').replace(',','.')); if(isNaN(v)) v=s.peso;
      s.peso=+v.toFixed(1);
    }else{
      let v=parseInt(inp.value,10); if(isNaN(v)) v=s.reps;
      s.reps=Math.max(1,Math.min(200,v));
    }
    save(state);
  }
});

/* ====== Top buttons ====== */
$('#btnGuardar').addEventListener('click', ()=>{ save(state); beep(1000,150,0.07); });
$('#btnReset').addEventListener('click', ()=>{
  if(!confirm('¬øReiniciar el d√≠a?')) return;
  clearTimers();
  state={autoNext:$('#autoNext').checked,theme:($('#lightMode').checked?'light':'dark'),current:{ex:0,serie:0,mode:'idle'},plan:JSON.parse(JSON.stringify(defaultPlan))};
  $('#restBanner').classList.add('hide'); render();
});

/* ====== Carga ====== */
window.addEventListener('load', ()=>{ render(); });
</script>
</body>
</html>