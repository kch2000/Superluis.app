<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SuperLuis.app</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">
<style>
  :root{
    --bg:#0b1220; --fg:#e7f1ff; --muted:#96a1b5; --accent:#00ffd1; --ok:#0dbb7c; --warn:#ffcc00; --danger:#ff5e7a;
    --card:#121a2c; --card2:#162036; --border:#22314f;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial; }
  .app{display:flex;flex-direction:column;min-height:100%}
  header{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,18,32,0.95), rgba(11,18,32,0.7));backdrop-filter:blur(10px);
    z-index:10;border-bottom:1px solid var(--border);}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{font-weight:800;letter-spacing:.5px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--card2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .container{padding:16px; max-width:820px; margin:0 auto; width:100%}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  button{background:var(--card2);border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
  button:hover{border-color:var(--accent)}
  .grid{display:grid; gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .exercise-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .exercise-title{font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .series{margin-top:10px}
  .serie{border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:8px;background:#0e1628}
  .serie.active{background:rgba(13,187,124,0.12);border-color:#0dbb7c}
  .serie.completed{background:rgba(13,187,124,0.22); border-color:#0dbb7c}
  .serie .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .chip{background:var(--card2);border:1px solid var(--border);padding:6px 8px;border-radius:10px}
  .chip.ok{background:rgba(13,187,124,.18);border-color:#0dbb7c}
  .restbar{position:sticky;top:52px;z-index:9;display:none}
  .restbar.visible{display:block}
  .rest-card{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#0f1322;border:1px solid var(--border);border-radius:14px;padding:10px}
  .rest-time{font-variant-numeric:tabular-nums;font-size:22px;font-weight:800;color:var(--warn)}
  .muted{color:var(--muted)}
  .done{background:rgba(13,187,124,.2)}
  .exercise.completed{background:rgba(13,187,124,.18);border-color:#0dbb7c}
  .row > .grow{flex:1}
</style>
</head>
<body>
<div class="app">
<header>
  <div class="nav">
    <div class="brand">SuperLuis.app</div>
    <div class="pill"><span id="modeLabel">Modo oscuro</span></div>
  </div>
  <div id="restbar" class="restbar">
    <div class="container">
      <div class="rest-card">
        <div>
          <div class="muted">Descanso</div>
          <div id="restMsg" class="small">Iniciamos descanso…</div>
        </div>
        <div class="rest-time" id="restTime">00</div>
        <div class="row">
          <button id="pauseRest">Pausar</button>
          <button id="skipRest">Saltar</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="toolbar">
    <button id="btnStartDay">Empezar ejercicio</button>
    <button id="btnImport">Importar rutina</button>
    <button id="btnMode">Modo</button>
  </div>

  <section id="today" class="grid">
    <!-- ejercicios render -->
  </section>
</main>
</div>

<script>
// ---- State base ----
const state = {
  exercises: [],
  activeExerciseIndex: 0,
  ttsEnabled: true,
  restCfg: { defaultSec: 60, minResumeSec: 10 },
  rest: { running:false, remaining:0, timer:null, paused:false },
  installingCapable: false
};

// ---- Utils ----
function say(text){
  return new Promise((resolve)=>{
    if(!('speechSynthesis' in window)) return resolve();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'es-ES';
    u.rate = 1.0;
    u.onend = ()=> resolve();
    u.onerror = ()=> resolve();
    window.speechSynthesis.speak(u);
  });
}
function playBeep(file){
  const a = new Audio(file);
  a.play().catch(()=>{});
}
function save(){
  localStorage.setItem('sl_routine', JSON.stringify(state.exercises));
}
function loadDefault(){
  // mínima rutina ejemplo
  state.exercises = [
    { name:'L410 – Press de pecho', machine:'L410', restSec:60,
      series:[ {targetReps:10, targetKg:70, done:false, reps:10, kg:70},
               {targetReps:10, targetKg:70, done:false, reps:10, kg:70},
               {targetReps:10, targetKg:70, done:false, reps:10, kg:70} ] },
    { name:'L090 – Seated Row', machine:'L090', restSec:60,
      series:[ {targetReps:8, targetKg:70, done:false, reps:8, kg:70},
               {targetReps:8, targetKg:70, done:false, reps:8, kg:70},
               {targetReps:8, targetKg:70, done:false, reps:8, kg:70} ] }
  ];
}
function load(){
  const raw = localStorage.getItem('sl_routine');
  if(raw){
    try{ state.exercises = JSON.parse(raw);}catch{ loadDefault(); }
  } else loadDefault();
}

// ---- Render ----
function render(){
  const host = document.getElementById('today');
  host.innerHTML = '';
  state.exercises.forEach((ex,ei)=>{
    const doneAll = ex.series.every(s=>s.done);
    const exEl = document.createElement('div');
    exEl.className = 'card exercise'+(doneAll?' completed':'');
    const hdr = document.createElement('div');
    hdr.className='exercise-header';
    hdr.innerHTML = `<div class="exercise-title">${ex.name}</div>
                     <div class="small">${ex.machine}</div>`;
    exEl.appendChild(hdr);
    // actions
    const actions = document.createElement('div');
    actions.className='toolbar';
    const btnToggle = document.createElement('button');
    btnToggle.textContent = 'Mostrar series';
    btnToggle.addEventListener('click',()=>{
      list.style.display = (list.style.display==='none'?'block':'none');
      btnToggle.textContent = (list.style.display==='none'?'Mostrar series':'Ocultar series');
    });
    const btnStart = document.createElement('button');
    btnStart.textContent = 'Iniciar serie';
    btnStart.addEventListener('click',()=>{
      startNextSeries(ei,true);
    });
    const btnAdd = document.createElement('button');
    btnAdd.textContent = 'Añadir serie';
    btnAdd.addEventListener('click',()=>{
      const last = ex.series[ex.series.length-1];
      ex.series.push({targetReps:last.targetReps, targetKg:last.targetKg, done:false, reps:last.reps, kg:last.kg});
      save(); render();
    });
    actions.append(btnToggle, btnStart, btnAdd);
    exEl.appendChild(actions);

    const list = document.createElement('div');
    list.className='series';
    list.style.display = 'none';

    ex.series.forEach((s,si)=>{
      const sEl = document.createElement('div');
      sEl.className = 'serie'+(s.done?' completed':'');
      if(!s.done && si===ex.series.findIndex(z=>!z.done)) sEl.classList.add('active');
      const row1 = document.createElement('div');
      row1.className='row';
      const label = document.createElement('div');
      label.className='chip';
      label.textContent = `Serie ${si+1}`;
      const planned = document.createElement('div');
      planned.className='chip';
      planned.textContent = `Previsto: ${s.targetReps} rep · ${s.targetKg} kg`;
      const actual = document.createElement('div');
      actual.className='chip ok';
      actual.textContent = `Real: ${s.reps} rep · ${s.kg.toFixed(1)} kg`;
      const grow = document.createElement('div'); grow.className='grow';
      row1.append(label, planned, actual, grow);
      sEl.appendChild(row1);

      const row2 = document.createElement('div');
      row2.className='row';
      // controls
      const kgMinus=document.createElement('button'); kgMinus.textContent='-0.5 kg';
      const kgPlus=document.createElement('button'); kgPlus.textContent='+0.5 kg';
      const repMinus=document.createElement('button'); repMinus.textContent='- rep';
      const repPlus=document.createElement('button'); repPlus.textContent='+ rep';
      [kgMinus,kgPlus,repMinus,repPlus].forEach(b=> b.disabled = s.done || isSerieRunning());
      kgMinus.addEventListener('click',()=>{ s.kg = +(s.kg-0.5).toFixed(1); actual.textContent=`Real: ${s.reps} rep · ${s.kg.toFixed(1)} kg`; save();});
      kgPlus.addEventListener('click',()=>{ s.kg = +(s.kg+0.5).toFixed(1); actual.textContent=`Real: ${s.reps} rep · ${s.kg.toFixed(1)} kg`; save();});
      repMinus.addEventListener('click',()=>{ s.reps = Math.max(1,(s.reps-1)); actual.textContent=`Real: ${s.reps} rep · ${s.kg.toFixed(1)} kg`; save();});
      repPlus.addEventListener('click',()=>{ s.reps = s.reps+1; actual.textContent=`Real: ${s.reps} rep · ${s.kg.toFixed(1)} kg`; save();});
      row2.append(kgMinus,kgPlus,repMinus,repPlus);
      sEl.appendChild(row2);

      const row3 = document.createElement('div');
      row3.className='row';
      const btnRun = document.createElement('button'); btnRun.textContent='Iniciar esta serie';
      btnRun.disabled = s.done || isSerieRunning();
      btnRun.addEventListener('click',()=> startSeries(ei, si));
      row3.append(btnRun);
      sEl.appendChild(row3);

      list.appendChild(sEl);
    });

    exEl.appendChild(list);
    host.appendChild(exEl);
  });
}

function isSerieRunning(){
  return !!document.body.dataset.running;
}

// ---- Series & Rest flow ----
async function startNextSeries(ei, fromTopBtn=false){
  const ex = state.exercises[ei];
  const si = ex.series.findIndex(s=>!s.done);
  if(si===-1){ return; }
  // auto-open series list
  if(fromTopBtn){
    // open list of this exercise
    // find the toggle button and force open
    // simpler: re-render and programmatically click the first 'Mostrar series' for that exercise
  }
  startSeries(ei, si);
}

async function startSeries(ei, si){
  if(isSerieRunning()) return;
  const ex = state.exercises[ei];
  const s = ex.series[si];
  // lock UI for running series
  document.body.dataset.running = "1";
  // highlight
  render(); // to apply disabled states

  // speak intro + count reps descending
  await say(`Empezamos serie ${si+1}.`);
  // Count down reps: s.reps -> 1
  for(let r=s.reps; r>=1; r--){
    await say(`${r}`);
    await say(`Arriba`);
    await say(`Abajo`);
  }

  // mark done
  s.done = true; save(); render();

  // start rest
  await startRest(ex.restSec || state.restCfg.defaultSec, ei, si);
}

async function startRest(seconds, ei, si){
  // show bar
  const bar = document.getElementById('restbar');
  const timeEl = document.getElementById('restTime');
  const msgEl = document.getElementById('restMsg');
  const btnPause = document.getElementById('pauseRest');
  const btnSkip = document.getElementById('skipRest');

  bar.classList.add('visible');
  state.rest.running = true;
  state.rest.paused = false;
  state.rest.remaining = seconds;
  msgEl.textContent = `Iniciamos descanso de ${seconds} segundos`;
  await say(`Iniciamos descanso de ${seconds} segundos`);

  let lastTs = Date.now();
  // clear old listeners
  btnPause.onclick = ()=>{
    if(!state.rest.running) return;
    if(!state.rest.paused){
      state.rest.paused = true;
      btnPause.textContent = 'Reanudar';
    }else{
      // resume with at least minResumeSec
      state.rest.paused = false;
      if(state.rest.remaining < ${10}) state.rest.remaining = ${10};
      btnPause.textContent = 'Pausar';
      // beep to warn resume in 10s?
    }
  };
  btnSkip.onclick = ()=>{
    // skip rest => immediately next series (if any)
    finishRest(true);
  };

  function tick(){
    if(!state.rest.running) return;
    const now = Date.now();
    const dt = Math.max(0, Math.floor((now - lastTs)/1000));
    lastTs = now;
    if(!state.rest.paused && dt>0){
      state.rest.remaining = Math.max(0, state.rest.remaining - dt);
      // beeps 3-2-1
      if(state.rest.remaining===3) playBeep('assets/audio/beep1.wav');
      if(state.rest.remaining===2) playBeep('assets/audio/beep2.wav');
      if(state.rest.remaining===1) playBeep('assets/audio/beep3.wav');
      if(state.rest.remaining>0 && state.rest.remaining % 10 === 0){
        say(`${state.rest.remaining} segundos`).catch(()=>{});
      }
      timeEl.textContent = state.rest.remaining.toString().padStart(2,'0');
      if(state.rest.remaining===0){
        finishRest(false);
        return;
      }
    }
    state.rest.timer = setTimeout(tick, 250);
  }
  function finishRest(skipped){
    clearTimeout(state.rest.timer); state.rest.timer=null;
    state.rest.running=false;
    bar.classList.remove('visible');
    // unlock series running
    delete document.body.dataset.running;
    // auto start next series if exists in SAME exercise
    const ex = state.exercises[ei];
    const nextSi = ex.series.findIndex(s=>!s.done);
    if(nextSi !== -1){
      startSeries(ei, nextSi);
    }else{
      // exercise complete -> visual mark
      render();
    }
  }

  tick();
}

// ---- Import ----
document.getElementById('btnImport').addEventListener('click', async ()=>{
  const txt = prompt('Pega aquí el JSON de la rutina');
  if(!txt) return;
  try{
    const data = JSON.parse(txt);
    // expected: [{name,machine,restSec,series:[{targetReps,targetKg,reps,kg,done:false},...]}]
    state.exercises = data;
    save(); render();
  }catch(e){
    alert('JSON inválido');
  }
});

document.getElementById('btnStartDay').addEventListener('click', ()=>{
  // Start first exercise first pending series
  startNextSeries(0,true);
});

document.getElementById('btnMode').addEventListener('click',()=>{
  document.documentElement.classList.toggle('light');
});

// Register SW (only works via http/https, not file://)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  });
}
load();
render();
</script>
</body>
</html>
